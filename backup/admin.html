<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¸¸æ˜¥è—¤èª²å¾Œæ‰è—å ±åå¾Œå°ç®¡ç†ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2f6f4e;
            --accent-red: #e07a5f;
            --bg-light: #f5f7fa;
            --text-dark: #2c3e50;
            --border-color: #dfe6e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), #3a8a5e);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary-color);
        }

        .stat-card.accent {
            border-left-color: var(--accent-red);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-card.accent .number {
            color: var(--accent-red);
        }

        .course-management {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .capacity-input {
            width: 80px;
            padding: 6px 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .capacity-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .remaining-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .remaining-badge.full {
            background-color: #f8d7da;
            color: #721c24;
        }

        .remaining-badge.low {
            background-color: #fff3cd;
            color: #856404;
        }

        .remaining-badge.ok {
            background-color: #d4edda;
            color: #155724;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #245a3e;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border-color);
            font-size: 14px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 40px;
            height: 20px;
            background-color: #ccc;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-block;
            vertical-align: middle;
        }

        .toggle-switch.active {
            background-color: #2ecc71;
        }

        .toggle-slider {
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 22px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #3a8a5e);
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .detail-value {
            color: var(--text-dark);
        }

        .course-list,
        .supply-list {
            list-style: none;
            padding: 0;
        }

        .course-list li,
        .supply-list li {
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .price {
            color: var(--accent-red);
            font-weight: 600;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 10px;
            }
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #4caf50;
        }

        .toast.success {
            border-left-color: #4caf50;
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast.warning {
            border-left-color: #ff9800;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 13px;
            color: #666;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .toast-close:hover {
            color: #666;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>ğŸ“Š å¸¸æ˜¥è—¤èª²å¾Œæ‰è—å ±åå¾Œå°ç®¡ç†ç³»çµ±</h1>
            <p>Ivy After-School Arts Registration Admin Panel</p>
        </div>
        <button onclick="logout()" class="btn btn-secondary"
            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white;">
            ğŸšª ç™»å‡º
        </button>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>ç¸½å ±åäººæ•¸</h3>
                <div class="number" id="totalRegistrations">0</div>
            </div>
            <div class="stat-card accent">
                <h3>ç¸½å­¸ç”Ÿæ•¸</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>èª²ç¨‹å ±åæ•¸</h3>
                <div class="number" id="totalCourses">0</div>
            </div>
            <div class="stat-card accent">
                <h3>ç”¨å“è¨‚è³¼æ•¸</h3>
                <div class="number" id="totalSupplies">0</div>
            </div>
        </div>

        <!-- Registration Time Settings -->
        <div class="course-management" style="margin-bottom: 20px;">
            <h2 style="margin-bottom: 15px; color: var(--text-dark);">â° å ±åæ™‚é–“è¨­å®š</h2>
            <div style="display: flex; gap: 30px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">é–‹å§‹æ™‚é–“</label>
                    <input type="datetime-local" id="registrationStart" class="capacity-input"
                        style="width: 100%; max-width: 300px; padding: 10px;">
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">çµæŸæ™‚é–“</label>
                    <input type="datetime-local" id="registrationEnd" class="capacity-input"
                        style="width: 100%; max-width: 300px; padding: 10px;">
                </div>
                <div style="flex: 0 0 auto;">
                    <button class="btn btn-primary" onclick="saveRegistrationTime()">
                        ğŸ’¾ å„²å­˜æ™‚é–“è¨­å®š
                    </button>
                </div>
            </div>
            <div id="registrationStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;">
            </div>
        </div>

        <!-- Course Capacity Management -->
        <div class="course-management">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="color: var(--text-dark); margin: 0;">ğŸ“š èª²ç¨‹ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="openCourseModal('add')">
                    â• æ–°å¢èª²ç¨‹
                </button>
            </div>
            <div class="table-container">
                <table id="coursesTable">
                    <thead>
                        <tr>
                            <th>èª²ç¨‹åç¨±</th>
                            <th>åƒ¹æ ¼</th>
                            <th>å ‚æ•¸</th>
                            <th>é »ç‡</th>
                            <th>å·²å ±å</th>
                            <th>å®¹é‡ä¸Šé™</th>
                            <th>å‰©é¤˜åé¡</th>
                            <th>å½±ç‰‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="coursesTableBody">
                        <tr>
                            <td colspan="8" class="loading">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å­¸ç”Ÿå§“åã€ç­ç´š..." />
            </div>
            <button class="btn btn-primary" onclick="loadRegistrations()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            <div class="col-md-4 text-right">
                <button class="btn btn-outline-secondary" onclick="exportDataCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
                <button class="btn btn-secondary" onclick="exportDataExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table id="registrationsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>å­¸ç”Ÿå§“å</th>
                        <th>ç­ç´š</th>
                        <th>èª²ç¨‹æ•¸</th>
                        <th>ç”¨å“æ•¸</th>
                        <th>ç¹³è²»</th>
                        <th>å ±åæ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7" class="loading">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ å ±åè©³ç´°è³‡æ–™</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Course Modal (Add/Edit) -->
    <div id="courseModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="courseModalTitle">â• æ–°å¢èª²ç¨‹</h2>
                <button class="modal-close" onclick="closeCourseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <input type="hidden" id="courseId">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">èª²ç¨‹åç¨± <span
                                style="color: red;">*</span></label>
                        <input type="text" id="courseName" class="capacity-input" style="width: 100%; padding: 10px;"
                            placeholder="ä¾‹ï¼šå¹¼å…’æ„Ÿçµ± (é™å°å¹¼ç­)" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">åƒ¹æ ¼ <span
                                    style="color: red;">*</span></label>
                            <input type="number" id="coursePrice" class="capacity-input"
                                style="width: 100%; padding: 10px;" placeholder="ä¾‹ï¼š5000" min="0" required>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">å ‚æ•¸</label>
                            <input type="number" id="courseSessions" class="capacity-input"
                                style="width: 100%; padding: 10px;" placeholder="ä¾‹ï¼š20" min="1">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">é »ç‡</label>
                            <input type="text" id="courseFrequency" class="capacity-input"
                                style="width: 100%; padding: 10px;" placeholder="ä¾‹ï¼šæ¯é€±1æ¬¡ï¼Œ1æ¬¡1å°æ™‚">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¹é‡ä¸Šé™</label>
                            <input type="number" id="courseCapacity" class="capacity-input"
                                style="width: 100%; padding: 10px;" placeholder="ä¾‹ï¼š30" min="1" value="30">
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">èªªæ˜</label>
                        <input type="text" id="courseDescription" class="capacity-input"
                            style="width: 100%; padding: 10px;" placeholder="ä¾‹ï¼šæ•™æè²»å¦è¨ˆ$1500">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">å½±ç‰‡é€£çµ/è·¯å¾‘</label>
                        <input type="text" id="courseVideoUrl" class="capacity-input"
                            style="width: 100%; padding: 10px;"
                            placeholder="ä¾‹ï¼švideos/dance.mp4 æˆ– https://youtube.com/...">
                        <p style="font-size: 12px; color: #666; margin-top: 4px;">æ”¯æ´ mp4 æª”æ¡ˆæˆ–å½±ç‰‡é€£çµ</p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeCourseModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">å¯†ç¢¼</label>
                        <input type="password" id="loginPassword" class="capacity-input"
                            style="width: 100%; padding: 12px; font-size: 16px;" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" required
                            autofocus>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        ğŸ”“ ç™»å…¥
                    </button>
                </form>
                <p style="text-align: center; margin-top: 15px; color: #7f8c8d; font-size: 14px;">
                    é è¨­å¯†ç¢¼ï¼šadmin123
                </p>
            </div>
        </div>
    </div>

    <script>
        // ============ Auth Configuration ============
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('adminToken') || '';
        let allRegistrations = [];
        let allCourses = [];

        // Helper function for authenticated API calls
        function authFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return fetch(url.startsWith('http') ? url : `${API_BASE}${url}`, {
                ...options,
                headers
            });
        }

        // Check if logged in on page load
        function checkAuth() {
            if (!authToken) {
                showLoginModal();
                return false;
            }
            return true;
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('loginPassword').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function logout() {
            authToken = '';
            localStorage.removeItem('adminToken');
            showLoginModal();
            showToast('å·²ç™»å‡º', 'è«‹é‡æ–°ç™»å…¥', 'warning');
        }

        // Handle login form
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();

                if (response.ok) {
                    authToken = result.token;
                    localStorage.setItem('adminToken', authToken);
                    hideLoginModal();
                    showToast('ç™»å…¥æˆåŠŸï¼', 'æ­¡è¿ä½¿ç”¨å¾Œå°ç®¡ç†ç³»çµ±', 'success');
                    loadAllData();
                } else {
                    showToast('ç™»å…¥å¤±æ•—', result.message || 'å¯†ç¢¼éŒ¯èª¤', 'error');
                    document.getElementById('loginPassword').value = '';
                    document.getElementById('loginPassword').focus();
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('é€£ç·šéŒ¯èª¤', 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨', 'error');
            }
        });

        function loadAllData() {
            loadRegistrations();
            loadCourses();
            loadRegistrationTime();
        }

        // Toast Notification System
        function showToast(title, message = '', type = 'success', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'ğŸ“¢'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;

            container.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Load all registrations on page load
        window.onload = function () {
            if (checkAuth()) {
                loadAllData();
            }
        };

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            filterRegistrations(searchTerm);
        });

        // ============ Registration Time Functions ============
        async function loadRegistrationTime() {
            try {
                const response = await authFetch('/api/settings/registration-time');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('registrationStart').value = data.start || '';
                    document.getElementById('registrationEnd').value = data.end || '';
                    updateRegistrationStatus(data.start, data.end);
                }
            } catch (error) {
                console.error('Error loading registration time:', error);
            }
        }

        function updateRegistrationStatus(start, end) {
            const statusDiv = document.getElementById('registrationStatus');
            const now = new Date();
            const startDate = start ? new Date(start) : null;
            const endDate = end ? new Date(end) : null;

            let status = '';
            let bgColor = '';
            let textColor = '';

            if (!startDate || !endDate) {
                status = 'âš ï¸ å°šæœªè¨­å®šå ±åæ™‚é–“';
                bgColor = '#fff3cd';
                textColor = '#856404';
            } else if (now < startDate) {
                const daysLeft = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                status = `â³ å ±åå°šæœªé–‹æ”¾ï¼ˆé‚„æœ‰ ${daysLeft} å¤©ï¼‰`;
                bgColor = '#fff3cd';
                textColor = '#856404';
            } else if (now > endDate) {
                status = 'ğŸ”’ å ±åå·²æˆªæ­¢';
                bgColor = '#f8d7da';
                textColor = '#721c24';
            } else {
                status = 'âœ… å ±åé–‹æ”¾ä¸­';
                bgColor = '#d4edda';
                textColor = '#155724';
            }

            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = bgColor;
            statusDiv.style.color = textColor;
            statusDiv.innerHTML = `<strong>${status}</strong>`;
        }

        async function saveRegistrationTime() {
            const start = document.getElementById('registrationStart').value;
            const end = document.getElementById('registrationEnd').value;

            if (!start || !end) {
                showToast('è«‹è¨­å®šæ™‚é–“', 'è«‹è¨­å®šé–‹å§‹å’ŒçµæŸæ™‚é–“', 'warning');
                return;
            }

            if (new Date(start) >= new Date(end)) {
                showToast('æ™‚é–“è¨­å®šéŒ¯èª¤', 'çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“', 'warning');
                return;
            }

            try {
                const response = await authFetch('/admin/settings/registration-time', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ start, end })
                });

                if (response.ok) {
                    showToast('è¨­å®šæˆåŠŸï¼', 'å ±åæ™‚é–“è¨­å®šå·²æ›´æ–°', 'success');
                    updateRegistrationStatus(start, end);
                } else {
                    const error = await response.json();
                    showToast('æ›´æ–°å¤±æ•—', error.message || 'æœªçŸ¥éŒ¯èª¤', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('é€£ç·šéŒ¯èª¤', 'ä¼ºæœå™¨é€£ç·šéŒ¯èª¤', 'error');
            }
        }

        // ============ Course Management Functions ============

        async function loadCourses() {
            try {
                const response = await authFetch('/admin/courses');
                if (response.status === 401) {
                    showLoginModal();
                    return;
                }
                if (response.ok) {
                    const data = await response.json();
                    allCourses = data.courses;
                    displayCourses(allCourses);
                } else {
                    console.error('Failed to load courses');
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        function displayCourses(courses) {
            const tbody = document.getElementById('coursesTableBody');

            if (courses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div>æ²’æœ‰èª²ç¨‹è³‡æ–™</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = courses
                .filter(course => !course.name.includes('æ•™æè²»')) // éæ¿¾æ‰æ•™æè²»
                .map(course => {
                    const remainingClass = course.remaining <= 0 ? 'full' :
                        course.remaining <= 5 ? 'low' : 'ok';
                    const remainingText = course.remaining <= 0 ? 'å·²é¡æ»¿' : course.remaining;
                    const videoBadge = course.video_url ? '<span class="badge badge-success">æœ‰</span>' : '<span style="color:#ccc">ç„¡</span>';

                    return `
                    <tr>
                        <td><strong>${course.name}</strong></td>
                        <td>$${course.price.toLocaleString()}</td>
                        <td>${course.sessions || '-'}</td>
                        <td>${course.frequency || '-'}</td>
                        <td><span class="badge badge-info">${course.used}</span></td>
                        <td>
                            <input type="number" 
                                   class="capacity-input" 
                                   id="capacity-${course.id}" 
                                   value="${course.capacity}" 
                                   min="0" 
                                   max="999">
                        </td>
                        <td><span class="remaining-badge ${remainingClass}">${remainingText}</span></td>
                        <td>${videoBadge}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="updateCapacity(${course.id})">
                                    ğŸ’¾
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="openCourseModal('edit', ${course.id})">
                                    âœï¸
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCourse(${course.id}, '${course.name.replace(/'/g, "\\'")}')">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');
        }

        async function updateCapacity(courseId) {
            const input = document.getElementById(`capacity-${courseId}`);
            const newCapacity = parseInt(input.value);

            if (isNaN(newCapacity) || newCapacity < 0) {
                showToast('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„å®¹é‡æ•¸å­—', 'warning');
                return;
            }

            try {
                const response = await authFetch(`/admin/course/${courseId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ capacity: newCapacity })
                });

                if (response.ok) {
                    showToast('æ›´æ–°æˆåŠŸï¼', 'å®¹é‡æ›´æ–°æˆåŠŸ', 'success');
                    loadCourses(); // Reload to show updated remaining
                } else {
                    const error = await response.json();
                    showToast('æ›´æ–°å¤±æ•—', error.message || 'æœªçŸ¥éŒ¯èª¤', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('é€£ç·šéŒ¯èª¤', 'ä¼ºæœå™¨é€£ç·šéŒ¯èª¤', 'error');
            }
        }

        // ============ Course CRUD Functions ============
        let currentEditCourseId = null;

        function openCourseModal(mode, courseId = null) {
            const modal = document.getElementById('courseModal');
            const title = document.getElementById('courseModalTitle');
            const form = document.getElementById('courseForm');

            // Reset form
            form.reset();
            document.getElementById('courseCapacity').value = '30';

            if (mode === 'add') {
                title.textContent = 'â• æ–°å¢èª²ç¨‹';
                currentEditCourseId = null;
                document.getElementById('courseId').value = '';
            } else if (mode === 'edit' && courseId) {
                title.textContent = 'âœï¸ ç·¨è¼¯èª²ç¨‹';
                currentEditCourseId = courseId;
                document.getElementById('courseId').value = courseId;

                // Fill form with existing course data
                const course = allCourses.find(c => c.id === courseId);
                if (course) {
                    document.getElementById('courseName').value = course.name;
                    document.getElementById('coursePrice').value = course.price;
                    document.getElementById('courseSessions').value = course.sessions || '';
                    document.getElementById('courseFrequency').value = course.frequency || '';
                    document.getElementById('courseCapacity').value = course.capacity || 30;
                    document.getElementById('courseDescription').value = course.description || '';
                    document.getElementById('courseVideoUrl').value = course.video_url || '';
                }
            }

            modal.style.display = 'block';
        }

        function closeCourseModal() {
            document.getElementById('courseModal').style.display = 'none';
            currentEditCourseId = null;
        }

        // Form submission handler
        document.getElementById('courseForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const courseData = {
                name: document.getElementById('courseName').value.trim(),
                price: parseInt(document.getElementById('coursePrice').value),
                sessions: document.getElementById('courseSessions').value ? parseInt(document.getElementById('courseSessions').value) : null,
                frequency: document.getElementById('courseFrequency').value.trim(),
                capacity: parseInt(document.getElementById('courseCapacity').value) || 30,
                description: document.getElementById('courseDescription').value.trim(),
                video_url: document.getElementById('courseVideoUrl').value.trim()
            };

            if (!courseData.name || isNaN(courseData.price)) {
                showToast('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«èª²ç¨‹åç¨±å’Œåƒ¹æ ¼', 'warning');
                return;
            }

            try {
                let response;
                if (currentEditCourseId) {
                    // Update existing course
                    response = await authFetch(`/admin/course/${currentEditCourseId}`, {
                        method: 'PUT',
                        body: JSON.stringify(courseData)
                    });
                } else {
                    // Create new course
                    response = await authFetch('/admin/course', {
                        method: 'POST',
                        body: JSON.stringify(courseData)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    showToast('æˆåŠŸï¼', result.message, 'success');
                    closeCourseModal();
                    loadCourses();
                } else {
                    showToast('æ“ä½œå¤±æ•—', result.message || 'æœªçŸ¥éŒ¯èª¤', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('é€£ç·šéŒ¯èª¤', 'ä¼ºæœå™¨é€£ç·šéŒ¯èª¤', 'error');
            }
        });

        async function deleteCourse(courseId, courseName) {
            showConfirm(
                'ç¢ºèªåˆªé™¤èª²ç¨‹ï¼Ÿ',
                `ç¢ºå®šè¦åˆªé™¤ã€Œ${courseName}ã€å—ï¼Ÿ\nâš ï¸ å¦‚æœè©²èª²ç¨‹æœ‰å ±åè¨˜éŒ„ï¼Œå°‡ç„¡æ³•åˆªé™¤ã€‚`,
                async () => {
                    try {
                        const response = await authFetch(`/admin/course/${courseId}`, {
                            method: 'DELETE'
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showToast('åˆªé™¤æˆåŠŸï¼', result.message, 'success');
                            loadCourses();
                        } else {
                            showToast('åˆªé™¤å¤±æ•—', result.message || 'ç„¡æ³•åˆªé™¤æ­¤èª²ç¨‹', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showToast('é€£ç·šéŒ¯èª¤', 'ä¼ºæœå™¨é€£ç·šéŒ¯èª¤', 'error');
                    }
                }
            );
        }

        // ============ Registration Functions ============
        async function loadRegistrations() {
            try {
                const response = await authFetch('/admin/registrations');
                if (response.ok) {
                    const data = await response.json();
                    allRegistrations = data.registrations;
                    updateStatistics(data.statistics);
                    displayRegistrations(allRegistrations);
                } else {
                    showError('ç„¡æ³•è¼‰å…¥è³‡æ–™');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('ä¼ºæœå™¨é€£ç·šéŒ¯èª¤');
            }
        }

        function updateStatistics(stats) {
            document.getElementById('totalRegistrations').textContent = stats.totalRegistrations || 0;
            document.getElementById('totalStudents').textContent = stats.totalStudents || 0;
            document.getElementById('totalCourses').textContent = stats.totalCourseEnrollments || 0;
            document.getElementById('totalSupplies').textContent = stats.totalSupplyOrders || 0;
        }

        function displayRegistrations(registrations) {
            const tbody = document.getElementById('tableBody');

            if (registrations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div>ç›®å‰æ²’æœ‰å ±åè³‡æ–™</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = registrations.map(reg => `
                <tr>
                    <td><span class="badge badge-info">#${reg.id}</span></td>
                    <td><strong>${reg.student_name}</strong></td>
                    <td>${reg.class_name || 'æœªæŒ‡å®š'}</td>
                    <td><span class="badge badge-success">${reg.course_count}</span></td>
                    <td><span class="badge badge-success">${reg.supply_count}</span></td>
                    <td>
                        <div class="toggle-switch ${reg.is_paid ? 'active' : ''}" onclick="togglePayment(${reg.id}, ${reg.is_paid})">
                            <div class="toggle-slider"></div>
                        </div>
                        <span style="font-size: 12px; color: ${reg.is_paid ? '#2ecc71' : '#95a5a6'}; margin-left: 5px;">
                            ${reg.is_paid ? 'å·²ç¹³è²»' : 'æœªç¹³è²»'}
                        </span>
                    </td>
                    <td>${formatDate(reg.created_at)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="viewDetails(${reg.id})">æŸ¥çœ‹</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRegistration(${reg.id}, '${reg.student_name}')">åˆªé™¤</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterRegistrations(searchTerm) {
            const filtered = allRegistrations.filter(reg =>
                reg.student_name.toLowerCase().includes(searchTerm) ||
                (reg.class_name && reg.class_name.toLowerCase().includes(searchTerm))
            );
            displayRegistrations(filtered);
        }

        async function viewDetails(id) {
            try {
                const response = await authFetch(`/admin/registration/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    showDetailModal(data);
                } else {
                    showToast('è¼‰å…¥å¤±æ•—', 'ç„¡æ³•è¼‰å…¥è©³ç´°è³‡æ–™', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('é€£ç·šéŒ¯èª¤', 'ä¼ºæœå™¨é€£ç·šéŒ¯èª¤', 'error');
            }
        }

        function showDetailModal(data) {
            const modalBody = document.getElementById('modalBody');

            const coursesHTML = data.courses.length > 0
                ? `<ul class="course-list">${data.courses.map(c => `<li><span>${c.name}</span><span class="price">$${c.price}</span></li>`).join('')}</ul>`
                : '<p style="color: #7f8c8d;">ç„¡</p>';

            const suppliesHTML = data.supplies.length > 0
                ? `<ul class="supply-list">${data.supplies.map(s => `<li><span>${s.name}</span><span class="price">$${s.price}</span></li>`).join('')}</ul>`
                : '<p style="color: #7f8c8d;">ç„¡</p>';

            const totalCost = [...data.courses, ...data.supplies].reduce((sum, item) => sum + parseInt(item.price), 0);

            modalBody.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">å ±å ID</div>
                    <div class="detail-value"><strong>#${data.id}</strong></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å­¸ç”Ÿå§“å</div>
                    <div class="detail-value"><strong>${data.student_name}</strong></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">ç­ç´š</div>
                    <div class="detail-value">${data.class_name || 'æœªæŒ‡å®š'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">ç¹³è²»ç‹€æ…‹</div>
                    <div class="detail-value">
                        <span class="badge ${data.is_paid ? 'badge-success' : 'badge-secondary'}">
                            ${data.is_paid ? 'å·²ç¹³è²»' : 'æœªç¹³è²»'}
                        </span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å ±åèª²ç¨‹</div>
                    <div class="detail-value">${coursesHTML}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">è¨‚è³¼ç”¨å“</div>
                    <div class="detail-value">${suppliesHTML}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">ç¸½é‡‘é¡</div>
                    <div class="detail-value"><strong style="font-size: 20px; color: var(--accent-red);">$${totalCost.toLocaleString()}</strong></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å ±åæ™‚é–“</div>
                    <div class="detail-value">${formatDate(data.created_at)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æœ€å¾Œæ›´æ–°</div>
                    <div class="detail-value">${formatDate(data.updated_at)}</div>
                </div>
            `;

            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        async function deleteRegistration(id, name) {
            showConfirm(
                'ç¢ºèªåˆªé™¤å ±åï¼Ÿ',
                `ç¢ºå®šè¦åˆªé™¤ ${name} çš„å ±åè³‡æ–™å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`,
                async () => {
                    try {
                        const response = await authFetch(`/admin/registration/${id}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            showToast('åˆªé™¤æˆåŠŸï¼', 'å ±åè³‡æ–™å·²åˆªé™¤', 'success');
                            loadRegistrations();
                        } else {
                            showToast('åˆªé™¤å¤±æ•—', 'ç„¡æ³•åˆªé™¤æ­¤è³‡æ–™', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showToast('é€£ç·šéŒ¯èª¤', 'ä¼ºæœå™¨é€£ç·šéŒ¯èª¤', 'error');
                    }
                }
            );
        }

        async function togglePayment(id, currentStatus) {
            try {
                const newStatus = !currentStatus;
                const response = await authFetch(`/admin/registration/${id}/payment`, {
                    method: 'PUT',
                    body: JSON.stringify({ paid: newStatus })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('æ›´æ–°æˆåŠŸ', result.message, 'success');
                    loadRegistrations(); // Reload to update UI
                } else {
                    showToast('æ›´æ–°å¤±æ•—', 'ç„¡æ³•æ›´æ–°ç¹³è²»ç‹€æ…‹', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('é€£ç·šéŒ¯èª¤', 'ä¼ºæœå™¨é€£ç·šéŒ¯èª¤', 'error');
            }
        }

        function exportDataExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    showToast('å…ƒä»¶è¼‰å…¥ä¸­', 'Excel å…ƒä»¶å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œæˆ–ä½¿ç”¨ CSV åŒ¯å‡º', 'warning');
                    return;
                }

                // Prepare data for Excel
                const headers = ['ID', 'å­¸ç”Ÿå§“å', 'ç­ç´š', 'èª²ç¨‹æ•¸', 'ç”¨å“æ•¸', 'ç¹³è²»', 'å ±åæ™‚é–“', 'æ›´æ–°æ™‚é–“'];
                const data = allRegistrations.map(reg => ({
                    'ID': reg.id,
                    'å­¸ç”Ÿå§“å': reg.student_name,
                    'ç­ç´š': reg.class_name || 'æœªæŒ‡å®š',
                    'èª²ç¨‹æ•¸': reg.course_count,
                    'ç”¨å“æ•¸': reg.supply_count,
                    'ç¹³è²»': reg.is_paid ? 'å·²ç¹³è²»' : 'æœªç¹³è²»',
                    'å ±åæ™‚é–“': formatDate(reg.created_at),
                    'æ›´æ–°æ™‚é–“': formatDate(reg.updated_at)
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(data, { header: headers });

                // Adjust column widths
                const wscols = [
                    { wch: 10 }, // ID
                    { wch: 15 }, // Name
                    { wch: 15 }, // Class
                    { wch: 10 }, // Courses
                    { wch: 10 }, // Supplies
                    { wch: 20 }, // Created At
                    { wch: 20 }  // Updated At
                ];
                ws['!cols'] = wscols;

                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "å ±åè³‡æ–™");

                // Generate filename
                const filename = `å ±åè³‡æ–™_${new Date().toISOString().split('T')[0]}.xlsx`;

                // Export using manual Blob method for better compatibility
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);

                showToast('åŒ¯å‡ºæˆåŠŸ', 'å ±åè³‡æ–™å·²åŒ¯å‡ºç‚º Excel æª”æ¡ˆ', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('åŒ¯å‡ºå¤±æ•—', 'ç„¡æ³•ç”¢ç”Ÿ Excel æª”æ¡ˆ', 'error');
            }
        }

        function exportDataCSV() {
            // Convert to CSV
            const headers = ['ID', 'å­¸ç”Ÿå§“å', 'ç­ç´š', 'èª²ç¨‹æ•¸', 'ç”¨å“æ•¸', 'ç¹³è²»', 'å ±åæ™‚é–“', 'æ›´æ–°æ™‚é–“'];
            const rows = allRegistrations.map(reg => [
                reg.id,
                reg.student_name,
                reg.class_name || 'æœªæŒ‡å®š',
                reg.course_count,
                reg.supply_count,
                reg.is_paid ? 'å·²ç¹³è²»' : 'æœªç¹³è²»',
                formatDate(reg.created_at),
                formatDate(reg.updated_at)
            ]);

            // Add BOM for Excel Chinese compatibility
            let csv = '\uFEFF' + headers.join(',') + '\n';
            csv += rows.map(row => row.map(field => `"${field}"`).join(',')).join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å ±åè³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('åŒ¯å‡ºæˆåŠŸ', 'å ±åè³‡æ–™å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆ', 'success');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showError(message) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <div>${message}</div>
                    </td>
                </tr>
            `;
        }

    </script>
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 10px;">âš ï¸</div>
            <h3 id="confirmTitle" style="margin-bottom: 10px;">ç¢ºèªåˆªé™¤ï¼Ÿ</h3>
            <p id="confirmMessage" style="color: #666; margin-bottom: 20px;">æ­¤æ“ä½œç„¡æ³•å¾©åŸ</p>
            <div class="form-actions" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                <button id="confirmBtn" class="btn btn-danger">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <script>
        let currentConfirmCallback = null;

        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').innerText = message; // Use innerText for newlines
            currentConfirmCallback = callback;

            const modal = document.getElementById('confirmModal');
            const confirmBtn = document.getElementById('confirmBtn');

            // Remove old listeners to avoid duplicates
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

            newBtn.addEventListener('click', () => {
                if (currentConfirmCallback) currentConfirmCallback();
                closeConfirmModal();
            });

            modal.style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentConfirmCallback = null;
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const detailModal = document.getElementById('detailModal');
            const courseModal = document.getElementById('courseModal');
            const confirmModal = document.getElementById('confirmModal');
            if (event.target === detailModal) {
                closeModal();
            }
            if (event.target === courseModal) {
                closeCourseModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }
    </script>
</body>

</html>